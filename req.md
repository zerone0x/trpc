# MVP 功能性需求文档

## 1. 产品目标

打造一款纯文字交互的开放世界 MMORPG 原型，让首批玩家能够：

1. 创建并登录账号，进入同一个共享世界；
2. 通过自然语言指令探索、移动、交互；
3. 与 AI 生成的地图、NPC、剧情实时互动，并在数据库中持久化；
4. 与其他在线玩家实时通信；
5. 在出现异常时安全退出并下次无缝继续。

## 2. 核心功能

| 模块 | 功能                    | 优先级 | 说明                                                                 |
| ---- | ----------------------- | ------ | -------------------------------------------------------------------- |
| 账户 | 注册 / 登录 / 登出      | P0     | 邮箱验证码 + OAuth（GitHub/Google）二选一即可；JWT + HttpOnly Cookie |
| 账户 | 自动续签                | P0     | 刷新令牌，前端隐式续签，7 天内免登录                                 |
| 角色 | 创建角色                | P0     | 1 个槽位：昵称（必填）、头像 URL（选填）                             |
| 角色 | 角色档案                | P1     | 个人属性（HP/MP/体力）、背包概要                                     |
| 世界 | 移动指令 (move N/E/S/W) | P0     | 进入不存在的 block 时后端即时生成                                    |
| 世界 | 查看场景 (look)         | P0     | 返回当前 block 描述及可交互对象                                      |
| 世界 | 对象交互 (interact/use) | P0     | 拾取、丢弃、使用道具；与 NPC 对话                                    |
| 世界 | AI 生成                 | P0     | 若请求对象/场景不存在，则调用 OpenAI 生成并写入 Qdrant               |
| 通信 | 文本流反馈              | P0     | WebSocket 双向流；≤50 字符分块                                       |
| 通信 | 聊天 (/tell)            | P1     | 私聊指令，服务器转发                                                 |
| UI   | 命令输入框              | P0     | ↑↓ 历史、Tab 补全                                                    |
| UI   | 消息窗口                | P0     | 自动滚动，可暂停；IndexedDB 缓存 500 条                              |
| UI   | HUD                     | P1     | 位置、HP/MP/体力、背包数量                                           |
| UI   | 在线玩家侧边栏          | P2     | 实时在线人数及列表                                                   |
| 数据 | 玩家状态持久化          | P0     | 位置、背包、属性写入 Qdrant payload                                  |
| 数据 | 世界块持久化            | P0     | 所有生成的 block/object/relationship 写入 Qdrant                     |
| 安全 | JWT 校验                | P0     | 所有 HTTP/WS 请求验证；未授权 401                                    |
| 安全 | 速率限制                | P1     | 每 IP/用户登录 & 指令速率限制                                        |
| 安全 | 内容审核                | P2     | 简易敏感词过滤，避免违规文本                                         |
| 运维 | 管理 API                | P1     | ban 用户、重置 world、查看玩家状态                                   |
| 运维 | 结构化日志              | P0     | pino 输出 JSON，错误率监控                                           |
| 运维 | 指标暴露                | P2     | /metrics Prometheus 兼容                                             |

## 3. 用户流程

1. 新用户访问 `/login`，使用邮箱注册并验证；
2. 登录成功后进入 `/play` 并创建角色；
3. 前端通过 WebSocket 连接后端，开始流式文本会话；
4. 玩家输入 `look` 获得场景描述；
5. 输入 `move north`，触发后端生成或加载目标 block；
6. AI 返回交互结果并推送至客户端消息窗口；
7. 玩家退出时自动保存状态，刷新令牌写入 Cookie；
8. 下次访问自动续签并恢复至上次位置。

## 4. 非功能要求

- **性能**：首屏可交互 ≤1.5 s；文本流延迟 ≤300 ms。
- **可扩展**：后端插件化服务，支持水平扩展。
- **可观测**：日志与指标覆盖关键路径；99.9% SLA。
- **安全**：遵循 OWASP Top 10；CSRF/XSF 全面防护。
- **可访问**：键盘导航、屏幕阅读器友好；i18n 预留。

## 5. MVP 出货准则

1. 列表中所有 P0 项完成并通过测试；
2. P1 项完成 ≥80%；
3. 端到端用例（登录 → 移动 → 交互 → 退出 → 恢复）稳定运行 30 min 无错误；
4. 页面 Lighthouse ≥90；单元 + 集成测试覆盖率 ≥60%；
5. 部署至生产环境，灰度 20% 用户无致命 bug。
